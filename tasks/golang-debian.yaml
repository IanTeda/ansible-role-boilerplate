---
# Tasks to install the latest Go version on Debian servers

- name: Install required packages for Go installation
  ansible.builtin.apt:
    name:
      - software-properties-common
    state: present
    update_cache: true
  become: true
  tags: [install]

- name: Add Golang backports PPA
  ansible.builtin.apt_repository:
    repo: 'ppa:longsleep/golang-backports'
    state: present
  become: true
  tags: [install]

- name: Update apt cache after adding PPA
  ansible.builtin.apt:
    update_cache: true
  become: true
  tags: [install]

- name: Install Go from APT PPA
  ansible.builtin.apt:
    name: golang-go
    state: latest
  become: true
  tags: [install]

- name: Add Go binary to PATH in /etc/profile.d
  ansible.builtin.copy:
    content: |
      export GOPATH=$HOME/go
      export GOBIN=$GOPATH/bin
    dest: /etc/profile.d/go.sh
    mode: '0644'
  become: true
  tags: [install]

- name: Source Go environment for current session
  ansible.builtin.shell: |
    export GOPATH=$HOME/go
    export GOBIN=$GOPATH/bin
  changed_when: false
  tags: [install]

- name: Verify Go installation
  ansible.builtin.command: go version
  register: go_install_verification
  changed_when: false
  tags: [install]

- name: Display installed Go version
  ansible.builtin.debug:
    msg: "Successfully installed Go: {{ go_install_verification.stdout }}"
  tags: [install]

- name: Create GOPATH directory for users
  file:
    path: "{{ ansible_env.HOME }}/go"
    state: directory
    mode: '0755'
  tags: [install]

- name: Create Go workspace directories
  file:
    path: "{{ ansible_env.HOME }}/go/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - src
    - bin
    - pkg
  tags: [install]

- name: Verify Go command is available
  ansible.builtin.command: which go
  register: go_which
  changed_when: false
  tags: [install, verify]

- name: Assert Go is installed and in PATH
  ansible.builtin.assert:
    that: go_which.rc == 0
    success_msg: "Go is installed and available in PATH"
    fail_msg: "Go is not found in PATH"
  tags: [install, verify]

- name: Verify GOPATH is set
  ansible.builtin.shell: echo $GOPATH
  register: gopath_check
  changed_when: false
  tags: [install, verify]

- name: Assert GOPATH is configured
  ansible.builtin.assert:
    that: gopath_check.stdout | length > 0
    success_msg: "GOPATH is configured: {{ gopath_check.stdout }}"
    fail_msg: "GOPATH is not set"
  tags: [install, verify]

- name: Test Go installation with hello world
  copy:
    content: |
      package main
      import "fmt"
      func main() {
          fmt.Println("Hello, Go!")
      }
    dest: "/tmp/hello.go"
    mode: '0644'
  tags: [install, verify]

- name: Compile and run test program
  ansible.builtin.shell: |
    cd /tmp
    go run hello.go
  register: go_test_output
  changed_when: false
  tags: [install, verify]

- name: Display test program output
  debug:
    msg: "Go test program output: {{ go_test_output.stdout }}"
  tags: [install, verify]

- name: Clean up test file
  file:
    path: "/tmp/hello.go"
    state: absent
  tags: [install, verify]

- name: Display installation summary
  ansible.builtin.debug:
    msg: |
      Go installation completed successfully!
      Version: {{ go_install_verification.stdout }}
      Installation path: /usr/bin/go (via apt)
      GOPATH: {{ ansible_env.HOME }}/go
      
      To use Go in your shell, run:
      source /etc/profile.d/go.sh
      
      Or add the following to your ~/.bashrc or ~/.profile:
      export GOPATH=$HOME/go
      export GOBIN=$GOPATH/bin
  tags: [install, verify]
