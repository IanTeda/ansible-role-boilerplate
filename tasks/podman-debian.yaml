---
# PODMAN INSTALLATION
# ===================
#
# Installs Podman on Debian systems.
# Reference:
# - https://podman.io/getting-started/installation
#

- name: Detect system architecture for Podman
  ansible.builtin.debug:
    msg: "Installing Podman on {{ ansible_architecture }} architecture ({{ ansible_distribution }} {{ ansible_distribution_release }})"
  tags: [install]

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  become: true
  tags: [install]

- name: Install Podman prerequisites
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  become: true
  loop:
    - apt-transport-https
    - ca-certificates
    - curl
    - gnupg
  tags: [install]

- name: Install Podman
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  become: true
  loop:
    - podman
    - uidmap         # For rootless containers
    - crun           # Fast container runtime (preferred over runc on ARM)
    - netavark       # Network stack
    - aardvark-dns   # DNS for containers
  tags: [install]

- name: Create Podman user
  ansible.builtin.user:
    name: "{{ boilerplate_podman.user }}"
    system: yes
    shell: /usr/sbin/nologin
    home: /var/lib/{{ boilerplate_podman.user }}
    create_home: no
  become: true
  tags: [install, config]

- name: Create Podman group
  ansible.builtin.group:
    name: "{{ boilerplate_podman.group }}"
    system: yes
  become: true
  tags: [install, config]

- name: Add users to podman group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: "{{ boilerplate_podman.group }}"
    append: yes
  become: true
  loop: "{{ boilerplate_fish.users }}"  # Assuming same users as fish
  tags: [install, config]

- name: Verify Podman installation
  ansible.builtin.command: podman --version
  register: podman_version
  changed_when: false
  tags: [install, config, verify]

- name: Show Podman version
  ansible.builtin.debug:
    msg: "Podman version: {{ podman_version.stdout }}"
  tags: [install, config, verify]

- name: Test Podman container functionality
  ansible.builtin.command: podman run --rm hello-world
  register: podman_test
  changed_when: false
  failed_when: false
  tags: [install, config, verify]

- name: Show Podman test results
  ansible.builtin.debug:
    msg: |
      Podman container test: {{ 'PASSED' if podman_test.rc == 0 else 'FAILED' }}
      {{ podman_test.stdout | default('') }}
      {{ podman_test.stderr | default('') }}
  tags: [install, config, verify]

- name: Verify users are in podman group
  ansible.builtin.command: "groups {{ item }}"
  register: podman_group_check
  changed_when: false
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config, verify]

- name: Assert users are in podman group
  ansible.builtin.assert:
    that: "'{{ boilerplate_podman.group }}' in podman_group_check.results | selectattr('item', 'equalto', item) | map(attribute='stdout') | list | first"
    fail_msg: "User {{ item }} is not in the {{ boilerplate_podman.group }} group!"
    success_msg: "User {{ item }} is in the {{ boilerplate_podman.group }} group."
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config, verify]
