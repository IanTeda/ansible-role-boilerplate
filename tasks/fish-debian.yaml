---
# FISH SHELL INSTALLATION
# ======================
#
# Installs and configures the Fish shell on Raspberry Pi.
# Reference: 
# - https://fishshell.com/
# - https://www.asciiart.eu/text-to-ascii-art
#
# Usage:
#   ansible-playbook playbook.yml --tags "fish, install, config, verify"
#

- name: Install Fish shell
  ansible.builtin.apt:
    name: fish
    state: present
    update_cache: yes
  become: true
  tags: [install]

- name: Set Fish as default shell for users
  ansible.builtin.user:
    name: "{{ item }}"
    shell: /usr/bin/fish
  become: true
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config]

- name: Create Fish config directory
  ansible.builtin.file:
    path: "/home/{{ item }}/.config/fish"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0755'
  become: true
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config]

- name: Automatic detect and configure lm-sensors
  ansible.builtin.command: sensors-detect --auto
  become: true
  changed_when: false
  tags: [install, config]

- name: Load coretemp kernel module for CPU temperature sensors
  community.general.modprobe:
    name: coretemp
    state: present
  become: true
  tags: [install, config]

- name: Ensure coretemp module is loaded at boot
  ansible.builtin.lineinfile:
    path: /etc/modules
    line: coretemp
    create: true
  become: true
  notify: Restart Host
  tags: [install, sensors]

- name: Deploy pretty Fish welcome message
  ansible.builtin.template:
    src: "templates/fish-welcome.j2"
    dest: "/home/{{ item }}/.config/fish/config.fish"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0644'
  become: true
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config]

- name: Verify Fish installation
  ansible.builtin.command: fish --version
  register: fish_version
  changed_when: false
  tags: [install, config, verify]

- name: Show Fish version
  ansible.builtin.debug:
    msg: "Fish shell version: {{ fish_version.stdout }}"
  tags: [verify]

- name: Verify Fish is the default shell for users
  ansible.builtin.command: "getent passwd {{ item }}"
  register: fish_shell_check
  changed_when: false
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config, verify]

- name: Assert Fish is the default shell for users
  ansible.builtin.assert:
    that:
      - "'/usr/bin/fish' in (fish_shell_check.results | selectattr('item', 'equalto', item) | map(attribute='stdout') | list | first)"
    fail_msg: "Fish is not the default shell for user {{ item }}!"
    success_msg: "Fish is the default shell for user {{ item }}."
  loop: "{{ boilerplate_fish.users }}"
  tags: [install, config, verify]