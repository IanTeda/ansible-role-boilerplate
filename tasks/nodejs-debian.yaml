---
# NODEJS INSTALLATION
# ===================
#
# Installs Node.js from NodeSource repository.
# Reference:
# - https://deb.nodesource.com/
# - https://github.com/nodesource/distributions
# - "https://deb.nodesource.com/setup_25.x -o nodesource_setup.sh"

- name: Install prerequisites for NodeSource repository
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
      - gnupg
    state: present
  become: true
  tags: [install]

- name: Download NodeSource GPG key
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key"
    dest: "/tmp/nodesource-repo.gpg.key"
  become: true
  tags: [install]

- name: Install GPG key to keyrings
  ansible.builtin.shell: "gpg --batch --yes --dearmor -o /usr/share/keyrings/nodesource.gpg /tmp/nodesource-repo.gpg.key"
  become: true
  tags: [install]

- name: Clean up temporary key file
  ansible.builtin.file:
    path: "/tmp/nodesource-repo.gpg.key"
    state: absent
  become: true
  tags: [install]

- name: Add NodeSource Node.js {{ boilerplate_nodejs.release }}.x repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ boilerplate_nodejs.release }}.x nodistro main"
    state: present
    filename: 'nodesource'
  become: true
  tags: [install]

- name: Update apt cache after adding NodeSource repo
  ansible.builtin.apt:
    update_cache: yes
  become: true
  tags: [install]

- name: Install Node.js {{ boilerplate_nodejs.release }}.x
  ansible.builtin.apt:
    name: nodejs
    state: latest
  become: true
  tags: [install]

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: nodejs_version
  changed_when: false
  tags: [install, verify]

- name: Show Node.js version
  ansible.builtin.debug:
    msg: "Installed Node.js version: {{ nodejs_version.stdout }}"
  tags: [install, verify]

- name: Verify Node.js version matches expected release
  ansible.builtin.assert:
    that: "nodejs_version.stdout | regex_search('^v' + boilerplate_nodejs.release)"
    fail_msg: "Installed Node.js version {{ nodejs_version.stdout }} does not match expected release {{ boilerplate_nodejs.release }}"
    success_msg: "Node.js {{ boilerplate_nodejs.release }}.x is correctly installed"
  tags: [install, verify]